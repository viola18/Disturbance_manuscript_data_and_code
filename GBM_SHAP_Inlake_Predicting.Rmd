---
title: "Gradient boosting and SHAP for Disturbance — Minimal‑Change Refactor"
author: "PJ Hanly"
date: "2025-04-02"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(tidyverse)
library(spsurvey)
library(data.table)
library(DALEX)
library(shapviz)
library(ggridges)
library(ggbeeswarm)
library(ingredients)
library(grid)
library(scales)
library(pROC)
library(fastshap)
library(caret)
library(randomForest)
library(progress)
library(viridis)
library(ConfusionTableR)
library(maps)
library(hexbin)
library(forcats)
library(ggthemes)
library(patchwork)
library(pdp)
library(sf)   
```

```{r helpers}
# Binary label creation
mk_labels <- function(y, thr, pos = "Exceed", neg = "Nonexceed") {
  out <- y >= thr
  out <- replace(out, out == TRUE,  pos)
  out <- replace(out, out == FALSE, neg)
  factor(out, levels = c(pos, neg))
}

# Class weights (0.5 * inverse frequency for each class)
mk_weights <- function(y_factor) {
  ifelse(y_factor == levels(y_factor)[1],
         (1 / table(y_factor)[1]) * 0.5,
         (1 / table(y_factor)[2]) * 0.5)
}

# SHAP long table + feature merge 
compute_shap_long <- function(final_model, X_fit, nsim = 25, seed = 5674) {
  set.seed(seed)
  sv <- fastshap::explain(
    object = final_model,
    X = X_fit,
    pred_wrapper = function(model, newdata) predict(model, newdata, type = "response"),
    nsim = nsim,
    adjust = TRUE
  )
  shap_long <- sv %>%
    as.data.frame() %>%
    mutate(id = dplyr::row_number()) %>%
    tidyr::pivot_longer(-id, names_to = "Feature", values_to = "SHAP")

  feat_long <- X_fit %>%
    as.data.frame() %>%
    mutate(id = dplyr::row_number()) %>%
    tidyr::pivot_longer(-id, names_to = "Feature", values_to = "RawValue")

  viz_data <- dplyr::left_join(shap_long, feat_long, by = c("id", "Feature"))

  # Order by mean |SHAP| and scaled color for plots
  top_features <- viz_data %>%
    dplyr::group_by(Feature) %>%
    dplyr::summarise(MeanAbsSHAP = mean(abs(SHAP), na.rm = TRUE), .groups = "drop") %>%
    dplyr::arrange(dplyr::desc(MeanAbsSHAP)) %>%
    dplyr::pull(Feature)

  viz_data$Feature <- factor(viz_data$Feature, levels = top_features)

  viz_data_scaled <- viz_data %>%
    dplyr::group_by(Feature) %>%
    dplyr::mutate(RawValue_scaled = scales::rescale(RawValue, to = c(0,1), na.rm = TRUE),
                  absSHAP = abs(SHAP)) %>%
    dplyr::ungroup()

  viz_data_scaled
}

# Unified beeswarm SHAP plot
mk_shap_plot <- function(viz_data_scaled, title_text) {
  label_map <- c(
    ag_total = "Agricultural landuse",
    value.soil_depthtobedrock_cm = "Depth to bedrock",
    value.runoff_inperyr = "Surface runoff",
    ws_area_ha = "Watershed area",
    lake_waterarea_ha = "Lake surface area",
    value.soil_kffact = "Kffact",
    value.soil_orgcarbon_gperkg = "Organic carbon",
    SNFA_MEAN = "Synthetic N fertilizer",
    Manure_P_kg_ha = "Manure P",
    lake_shorelinedevfactor = "Shoreline development factor",
    value.soil_clay_pct = "Clay in soil",
    P_Ag_Buffered = "Buffered ag",
    HUC12_Pop = "HU12 population",
    nlcd_devsum_pct = "Developed area",
    PIMPV = "Impervious surface",
    DMR_Organic_Enrichment_Disch = "BOD/COD discharges",
    DMR_Metals_TWPE_lb_eq_yr = "Permitted metal pollutant loadings",
    Number_of_CSOs = "CSOs"
  )

  ggplot(viz_data_scaled,
         aes(x = SHAP, y = Feature, color = RawValue_scaled, size = absSHAP)) +
    geom_jitter(height = 0.25, width = 0, alpha = 0.8, stroke = 0.1) +
    scale_color_viridis(option = "C", direction = -1, name = "Scaled Raw
Value") +
    scale_y_discrete(
      limits = rev(levels(viz_data_scaled$Feature)),
      labels = function(x) ifelse(x %in% names(label_map), label_map[x], x)
    ) +
    scale_size_continuous(name = "SHAP
Magnitude", range = c(0.5, 4)) +
    labs(title = title_text, x = "SHAP Value", y = NULL) +
    theme_minimal(base_size = 14) +
    theme(
      legend.position = "right",
      axis.text.y = element_text(face = "bold", color = "black"),
      axis.text.x = element_text(color = "black"),
      plot.title  = element_text(face = "bold", size = 16, hjust = 0.5)
    ) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 1)
}
```

---

## Read & Merge Data

```{r read-data}
# Read
inlake  <- fread("no_missing_NLA_final.csv")
sem_out <- fread("SEM_predictions_bounded.csv")

# Merge 
inlake <- merge(
  inlake,
  sem_out[, c("lagoslakeid", "Urban_lake_disturbance", "Agr_Ws_flow", "Soils", "Morphometry", "Eutrophication")],
  by = "lagoslakeid", all.x = TRUE, all.y = FALSE
)

inlake_pred <- merge(inlake, sem_out, by = "lagoslakeid", all.x = TRUE, all.y = FALSE)
```

## Convert to Spatial Points

```{r spatial}
# SF objects
inlake_geo <- st_as_sf(
  x = inlake,
  coords = c("lake_lon_decdeg", "lake_lat_decdeg"),
  crs = 4326
)
inlake_geo <- st_transform(inlake_geo, crs = 5070)

# Indices for matching after GRTS
inlake$index      <- 1:nrow(inlake)
inlake_geo$index  <- 1:nrow(inlake_geo)
inlake_pred$index <- 1:nrow(inlake_pred)
```

## Train/Test Split via GRTS 

```{r grts}
set.seed(54632)  
inlake_split <- floor(0.75 * nrow(inlake_geo))
inlake_g     <- grts(inlake_geo, n_base = inlake_split)

inlake_train     <- inlake[inlake$index %in% inlake_g$sites_base$index, ]
inlake_test      <- inlake[!inlake$index %in% inlake_g$sites_base$index, ]
inlake_pred_test <- inlake_pred[!inlake_pred$index %in% inlake_g$sites_base$index, ]
```

---

# Atrazine Block 

```{r atrazine-model}
# Feature matrix & labels 
X_train_atz <- as.matrix(inlake_train[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha"
)])
Y_train_atz <- inlake_train[, c("atrazine")]
train_set_atz <- data.frame(atrazine = Y_train_atz, X_train_atz)
train_set_atz$atrazine <- mk_labels(train_set_atz$atrazine, 3)

X_test_atz <- as.matrix(inlake_test[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha"
)])
Y_test_atz <- inlake_test[, c("atrazine")]
test_set_atz <- data.frame(atrazine = Y_test_atz, X_test_atz)
test_set_atz$atrazine <- mk_labels(test_set_atz$atrazine, 3)

# Weights
model_weights_atz <- mk_weights(train_set_atz$atrazine)

# Caret control
cont <- trainControl(method = "repeatedcv", number = 10, repeats = 5,
                     summaryFunction = twoClassSummary, classProbs = TRUE)

# Seed & training 
set.seed(8384)
weighted_fit_atz <- train(atrazine ~ ., data = train_set_atz, method = "gbm",
                          verbose = FALSE, weights = model_weights_atz,
                          metric = "ROC", trControl = cont)
weighted_fit_atz

# Predictions & confusion matrix
probs_atz <- predict(weighted_fit_atz, newdata = test_set_atz, type = "prob")
preds_atz <- predict(weighted_fit_atz, newdata = test_set_atz, type = "raw")
predicted_atz <- cbind(data.frame(class_preds = preds_atz), test_set_atz)
atz_cm <- ConfusionTableR::binary_class_cm(predicted_atz$class_preds,
                                           as.factor(predicted_atz$atrazine))

ConfusionTableR::binary_visualiseR(
  train_labels = predicted_atz$class_preds,
  truth_labels = as.factor(predicted_atz$atrazine),
  class_label1 = "Exceed", class_label2 = "Non-Exceed",
  quadrant_col1 = "#FF6961", quadrant_col2 = "#4397D2",
  custom_title = "Atrazine", text_col = "black")
```

```{r atrazine-shap}
# SHAP 
X <- weighted_fit_atz$trainingData
X_features <- X[, !(names(X) %in% c(".outcome"))]
y <- X$.outcome

viz_data_scaled_atz <- compute_shap_long(
  final_model = weighted_fit_atz$finalModel,
  X_fit = X_features,
  nsim = 25,
  seed = 5674
)

# Beeswarm 
atz_shap <- mk_shap_plot(viz_data_scaled_atz, "Atrazine Model")
atz_shap
```

```{r atrazine-dependence}
# Dependence plots
# Agriculture (ag_total)
plt_atz_ag <- ggplot(viz_data_scaled_atz[viz_data_scaled_atz$Feature == "ag_total",],
                     aes(x = RawValue, y = SHAP)) +
  xlab("Watershed agriculture (%)") +
  geom_point(alpha = 0.4, color = "darkorange") +
  geom_smooth(method = "loess", se = FALSE, color = "black") +
  labs(title = "SHAP Dependence: Agriculture", x = "ag_total", y = "SHAP value") +
  theme_bw()
plt_atz_ag
```

```{r atrazine-pdp}
# PDP for ag_total
pdp_ag <- partial(
  object = weighted_fit_atz,
  pred.var = "ag_total",
  type = "classification",
  which.class = "Exceed",
  prob = TRUE,
  grid.resolution = 200,
  parallel = FALSE
)

plot(pdp_ag)
pdp_ag$prob <- plogis(pdp_ag$yhat)

ggplot(pdp_ag, aes(x = ag_total, y = prob)) +
  geom_point(alpha = 0.25, color = "#d55e00", size = 2) +
  geom_smooth(method = "loess", se = FALSE, color = "#333333", linewidth = 1.1) +
  labs(x = "Watershed agriculture (%)",
       y = paste0("Partial dependence atrazine exceedence")) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
        axis.title = element_text(size = 13, face = "bold"),
        axis.text = element_text(size = 12),
        panel.grid.major = element_line(color = "#eaeaea"),
        panel.grid.minor = element_blank())
```

```{r atrazine-more-dep}
# Additional dependence 
for (feat in c("SNFA_MEAN", "ag_total", "value.soil_kffact", "value.runoff_inperyr")) {
  df <- viz_data_scaled_atz[viz_data_scaled_atz$Feature == feat, ]
  p <- ggplot(df, aes(x = RawValue, y = SHAP)) +
    geom_point(alpha = 0.25, color = "#d55e00", size = 2) +
    geom_smooth(method = "loess", se = FALSE, color = "#333333", linewidth = 1.1) +
    labs(x = switch(feat,
                    SNFA_MEAN = "Synthetic N fertilizer (kg N/yr ag lands)",
                    ag_total = "Watershed agriculture (%)",
                    value.soil_kffact = "Watershed soil erodibility factor",
                    value.runoff_inperyr = "Watershed runoff per yr (in)",
                    feat),
         y = "SHAP value") +
    theme_minimal(base_size = 14) +
    theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
          axis.title = element_text(size = 13, face = "bold"),
          axis.text = element_text(size = 12),
          panel.grid.major = element_line(color = "#eaeaea"),
          panel.grid.minor = element_blank())
  print(p)
}
```

---

# Microcystin Block 

```{r microcystin}
X_train_mc <- as.matrix(inlake_train[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha"
)])
Y_train_mc <- inlake_train[, c("microcystin")]
train_set_mc <- data.frame(microcystin = Y_train_mc, X_train_mc)
train_set_mc$microcystin <- mk_labels(train_set_mc$microcystin, 1)

X_test_mc <- as.matrix(inlake_test[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha"
)])
Y_test_mc <- inlake_test[, c("microcystin")]
test_set_mc <- data.frame(microcystin = Y_test_mc, X_test_mc)
test_set_mc$microcystin <- mk_labels(test_set_mc$microcystin, 1)

model_weights_mc <- mk_weights(train_set_mc$microcystin)

cont <- trainControl(method = "repeatedcv", number = 10, repeats = 5,
                     summaryFunction = twoClassSummary, classProbs = TRUE)
set.seed(8384)
weighted_fit_mc <- train(microcystin ~ ., data = train_set_mc, method = "gbm",
                         verbose = FALSE, weights = model_weights_mc,
                         metric = "ROC", trControl = cont)

probs_mc <- predict(weighted_fit_mc, newdata = test_set_mc, type = "prob")
preds_mc <- predict(weighted_fit_mc, newdata = test_set_mc, type = "raw")
predicted_mc <- cbind(data.frame(class_preds = preds_mc), test_set_mc)
mc_cm <- ConfusionTableR::binary_class_cm(predicted_mc$class_preds, as.factor(predicted_mc$microcystin))
```

```{r microcystin-shap}
X <- weighted_fit_mc$trainingData
X_features <- X[, !(names(X) %in% c(".outcome"))]
y <- X$.outcome

viz_data_scaled_mc <- compute_shap_long(weighted_fit_mc$finalModel, X_features, 25, 5674)

micro_shap <- mk_shap_plot(viz_data_scaled_mc, "Microcystin Model")
micro_shap
```

# Chl-a Block

```{r chla}
X_train_chl <- as.matrix(inlake_train[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha"
)])
Y_train_chl <- inlake_train[, c("chla")]
train_set_chl <- data.frame(chla = Y_train_chl, X_train_chl)
train_set_chl$chla <- mk_labels(train_set_chl$chla, 30)

X_test_chl <- as.matrix(inlake_test[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha"
)])
Y_test_chl <- inlake_test[, c("chla")]
test_set_chl <- data.frame(chla = Y_test_chl, X_test_chl)
test_set_chl$chla <- mk_labels(test_set_chl$chla, 30)

model_weights_chl <- mk_weights(train_set_chl$chla)

cont <- trainControl(method = "repeatedcv", number = 10, repeats = 5,
                     summaryFunction = twoClassSummary, classProbs = TRUE)
set.seed(8384)
weighted_fit_chl <- train(chla ~ ., data = train_set_chl, method = "gbm",
                          verbose = FALSE, weights = model_weights_chl,
                          metric = "ROC", trControl = cont)

probs_chl <- predict(weighted_fit_chl, newdata = test_set_chl, type = "prob")
preds_chl <- predict(weighted_fit_chl, newdata = test_set_chl, type = "raw")
predicted_chl <- cbind(data.frame(class_preds = preds_chl), test_set_chl)
chl_cm <- ConfusionTableR::binary_class_cm(predicted_chl$class_preds, as.factor(predicted_chl$chla))
```

```{r chla-shap}
X <- weighted_fit_chl$trainingData
X_features <- X[, !(names(X) %in% c(".outcome"))]
y <- X$.outcome

viz_data_scaled_chl <- compute_shap_long(weighted_fit_chl$finalModel, X_features, 25, 5674)

chl_shap <- mk_shap_plot(viz_data_scaled_chl, "Chl-a Model")
chl_shap
```

# TP Block

```{r tp}
X_train_tp <- as.matrix(inlake_train[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha"
)])
Y_train_tp <- inlake_train[, c("tp")]
train_set_tp <- data.frame(tp = Y_train_tp, X_train_tp)
train_set_tp$tp <- mk_labels(train_set_tp$tp, 100)

X_test_tp <- as.matrix(inlake_test[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha"
)])
Y_test_tp <- inlake_test[, c("tp")]
test_set_tp <- data.frame(tp = Y_test_tp, X_test_tp)
test_set_tp$tp <- mk_labels(test_set_tp$tp, 100)

model_weights_tp <- mk_weights(train_set_tp$tp)

cont <- trainControl(method = "repeatedcv", number = 10, repeats = 5,
                     summaryFunction = twoClassSummary, classProbs = TRUE)
set.seed(8384)
weighted_fit_tp <- train(tp ~ ., data = train_set_tp, method = "gbm",
                         verbose = FALSE, weights = model_weights_tp,
                         metric = "ROC", trControl = cont)

probs_tp <- predict(weighted_fit_tp, newdata = test_set_tp, type = "prob")
preds_tp <- predict(weighted_fit_tp, newdata = test_set_tp, type = "raw")
predicted_tp <- cbind(data.frame(class_preds = preds_tp), test_set_tp)
tp_cm <- ConfusionTableR::binary_class_cm(predicted_tp$class_preds, as.factor(predicted_tp$tp))
```

```{r tp-shap}
X <- weighted_fit_tp$trainingData
X_features <- X[, !(names(X) %in% c(".outcome"))]
y <- X$.outcome

viz_data_scaled_tp <- compute_shap_long(weighted_fit_tp$finalModel, X_features, 25, 5674)

tp_shap <- mk_shap_plot(viz_data_scaled_tp, "TP Model")
tp_shap
```

# TN Block

```{r tn}
X_train_tn <- as.matrix(inlake_train[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha"
)])
Y_train_tn <- inlake_train[, c("tn")]
train_set_tn <- data.frame(tn = Y_train_tn, X_train_tn)
train_set_tn$tn <- mk_labels(train_set_tn$tn, 3)

X_test_tn <- as.matrix(inlake_test[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha"
)])
Y_test_tn <- inlake_test[, c("tn")]
test_set_tn <- data.frame(tn = Y_test_tn, X_test_tn)
test_set_tn$tn <- mk_labels(test_set_tn$tn, 3)

model_weights_tn <- mk_weights(train_set_tn$tn)

cont <- trainControl(method = "repeatedcv", number = 10, repeats = 5,
                     summaryFunction = twoClassSummary, classProbs = TRUE)
set.seed(8384)
weighted_fit_tn <- train(tn ~ ., data = train_set_tn, method = "gbm",
                         verbose = FALSE, weights = model_weights_tn,
                         metric = "ROC", trControl = cont)

probs_tn <- predict(weighted_fit_tn, newdata = test_set_tn, type = "prob")
preds_tn <- predict(weighted_fit_tn, newdata = test_set_tn, type = "raw")
predicted_tn <- cbind(data.frame(class_preds = preds_tn), test_set_tn)
tn_cm <- ConfusionTableR::binary_class_cm(predicted_tn$class_preds, as.factor(predicted_tn$tn))
```

```{r tn-shap}
X <- weighted_fit_tn$trainingData
X_features <- X[, !(names(X) %in% c(".outcome"))]
y <- X$.outcome

viz_data_scaled_tn <- compute_shap_long(weighted_fit_tn$finalModel, X_features, 25, 5674)

tn_shap <- mk_shap_plot(viz_data_scaled_tn, "TN Model")
tn_shap
```

# E. coli Block (urban features)

```{r ecoli}
X_train_ecoli <- as.matrix(inlake_train[, c(
  "PIMPV", "Number_of_CSOs", "HUC12_Pop", "nlcd_devsum_pct",
  "DMR_Organic_Enrichment_Disch", "DMR_Metals_TWPE_lb_eq_yr"
)])
Y_train_ecoli <- inlake_train[, c("ecoli")]
train_set_ecoli <- data.frame(ecoli = Y_train_ecoli, X_train_ecoli)
train_set_ecoli$ecoli <- mk_labels(train_set_ecoli$ecoli, 10)

X_test_ecoli <- as.data.frame(inlake_test[, c(
  "PIMPV", "Number_of_CSOs", "HUC12_Pop", "nlcd_devsum_pct",
  "DMR_Organic_Enrichment_Disch", "DMR_Metals_TWPE_lb_eq_yr"
)])
Y_test_ecoli <- inlake_test[, c("ecoli")]
test_set_ecoli <- data.frame(ecoli = Y_test_ecoli, X_test_ecoli)
test_set_ecoli$ecoli <- mk_labels(test_set_ecoli$ecoli, 10)

model_weights_ecoli <- mk_weights(train_set_ecoli$ecoli)

cont <- trainControl(method = "repeatedcv", number = 10, repeats = 5,
                     summaryFunction = twoClassSummary, classProbs = TRUE)
set.seed(8384)
weighted_fit_ecoli <- train(ecoli ~ ., data = train_set_ecoli, method = "gbm",
                            verbose = FALSE, weights = model_weights_ecoli,
                            metric = "Spec", trControl = cont)

probs_ecoli <- predict(weighted_fit_ecoli, newdata = test_set_ecoli, type = "prob")
preds_ecoli <- predict(weighted_fit_ecoli, newdata = test_set_ecoli, type = "raw")
predicted_ecoli <- cbind(data.frame(class_preds = preds_ecoli), test_set_ecoli)
ecoli_cm <- ConfusionTableR::binary_class_cm(predicted_ecoli$class_preds, as.factor(predicted_ecoli$ecoli))
```

```{r ecoli-shap}
X <- weighted_fit_ecoli$trainingData
X_features <- X[, !(names(X) %in% c(".outcome"))]
y <- X$.outcome

viz_data_scaled_ecoli <- compute_shap_long(weighted_fit_ecoli$finalModel, X_features, 25, 5674)

ecoli_shap <- mk_shap_plot(viz_data_scaled_ecoli, "E. coli Model")
ecoli_shap
```

# Mercury Block (ag + urban features)

```{r mercury}
X_train_mercury <- as.matrix(inlake_train[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha",
  "PIMPV", "Number_of_CSOs", "HUC12_Pop", "nlcd_devsum_pct",
  "DMR_Organic_Enrichment_Disch", "DMR_Metals_TWPE_lb_eq_yr"
)])
Y_train_mercury <- inlake_train[, c("mercury")]
train_set_mercury <- data.frame(mercury = Y_train_mercury, X_train_mercury)
train_set_mercury$mercury <- mk_labels(train_set_mercury$mercury, 0.203)

X_test_mercury <- as.matrix(inlake_test[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha",
  "PIMPV", "Number_of_CSOs", "HUC12_Pop", "nlcd_devsum_pct",
  "DMR_Organic_Enrichment_Disch", "DMR_Metals_TWPE_lb_eq_yr"
)])
Y_test_mercury <- inlake_test[, c("mercury")]
test_set_mercury <- data.frame(mercury = Y_test_mercury, X_test_mercury)
test_set_mercury$mercury <- mk_labels(test_set_mercury$mercury, 0.203)

model_weights_mercury <- mk_weights(train_set_mercury$mercury)

cont <- trainControl(method = "repeatedcv", number = 10, repeats = 5,
                     summaryFunction = twoClassSummary, classProbs = TRUE)
set.seed(8384)
weighted_fit_mercury <- train(mercury ~ ., data = train_set_mercury, method = "gbm",
                              verbose = FALSE, weights = model_weights_mercury,
                              metric = "ROC", trControl = cont)

probs_mercury <- predict(weighted_fit_mercury, newdata = test_set_mercury, type = "prob")
preds_mercury <- predict(weighted_fit_mercury, newdata = test_set_mercury, type = "raw")
predicted_mercury <- cbind(data.frame(class_preds = preds_mercury), test_set_mercury)
mercury_cm <- ConfusionTableR::binary_class_cm(predicted_mercury$class_preds, as.factor(predicted_mercury$mercury))
```

```{r mercury-shap}
X <- weighted_fit_mercury$trainingData
X_features <- X[, !(names(X) %in% c(".outcome"))]
y <- X$.outcome

viz_data_scaled_mercury <- compute_shap_long(weighted_fit_mercury$finalModel, X_features, 25, 5674)

merc_shap <- mk_shap_plot(viz_data_scaled_mercury, "Mercury Model")
merc_shap
```

# DOC Block (ag + urban features)

```{r doc}
X_train_DOC <- as.matrix(inlake_train[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha",
  "PIMPV", "Number_of_CSOs", "HUC12_Pop", "nlcd_devsum_pct",
  "DMR_Organic_Enrichment_Disch", "DMR_Metals_TWPE_lb_eq_yr"
)])
Y_train_DOC <- inlake_train[, c("DOC")]
train_set_DOC <- data.frame(DOC = Y_train_DOC, X_train_DOC)
train_set_DOC$DOC <- mk_labels(train_set_DOC$DOC, 15.8)

X_test_DOC <- as.matrix(inlake_test[, c(
  "value.soil_clay_pct", "SNFA_MEAN", "P_Ag_Buffered", "Manure_P_kg_ha",
  "value.runoff_inperyr", "ag_total", "value.soil_kffact", "value.soil_depthtobedrock_cm",
  "value.soil_orgcarbon_gperkg", "lake_shorelinedevfactor", "lake_waterarea_ha", "ws_area_ha",
  "PIMPV", "Number_of_CSOs", "HUC12_Pop", "nlcd_devsum_pct",
  "DMR_Organic_Enrichment_Disch", "DMR_Metals_TWPE_lb_eq_yr"
)])
Y_test_DOC <- inlake_test[, c("DOC")]
test_set_DOC <- data.frame(DOC = Y_test_DOC, X_test_DOC)
test_set_DOC$DOC <- mk_labels(test_set_DOC$DOC, 15.8)

model_weights_DOC <- mk_weights(train_set_DOC$DOC)

cont <- trainControl(method = "repeatedcv", number = 10, repeats = 5,
                     summaryFunction = twoClassSummary, classProbs = TRUE)
set.seed(8384)
weighted_fit_DOC <- train(DOC ~ ., data = train_set_DOC, method = "gbm",
                          verbose = FALSE, weights = model_weights_DOC,
                          metric = "ROC", trControl = cont)

probs_DOC <- predict(weighted_fit_DOC, newdata = test_set_DOC, type = "prob")
preds_DOC <- predict(weighted_fit_DOC, newdata = test_set_DOC, type = "raw")
predicted_DOC <- cbind(data.frame(class_preds = preds_DOC), test_set_DOC)
DOC_cm <- ConfusionTableR::binary_class_cm(predicted_DOC$class_preds, as.factor(predicted_DOC$DOC))
```

```{r doc-shap}
X <- weighted_fit_DOC$trainingData
X_features <- X[, !(names(X) %in% c(".outcome"))]
y <- X$.outcome

viz_data_scaled_DOC <- compute_shap_long(weighted_fit_DOC$finalModel, X_features, 25, 5674)

doc_shap <- mk_shap_plot(viz_data_scaled_DOC, "DOC Model")
doc_shap
```

---

## Final Figure Grid 

```{r final-figure}
common_size  <- scale_size_continuous(
  name   = "SHAP
Magnitude",
  range  = c(0.5, 4),
  limits = c(0, 0.30),
  breaks = c(0.0, 0.1, 0.2, 0.3)
)

common_color <- scale_color_viridis_c(
  name   = "Scaled Raw
Value",
  option = "C", direction = -1,
  limits = c(0, 1),
  breaks = c(0, 0.25, 0.5, 0.75, 1.0),
  guide  = guide_colorbar(
    title.position = "top", title.hjust = 0.5,
    barwidth  = unit(120, "mm"),
    barheight = unit(10,  "mm"),
    label.hjust = 0.5,
    label.theme = element_text(
      size = rel(2),
      margin = ggplot2::margin(t = 2, b = 2, unit = "pt")
    )
  )
)

p_grid <-
  wrap_plots(
    atz_shap, chl_shap, doc_shap, ecoli_shap,
    merc_shap, micro_shap, tn_shap, tp_shap,
    ncol = 2, nrow = 4
  ) +
  plot_layout(guides = "collect") &
  common_size &
  common_color &
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = rel(2)),
    legend.text  = element_text(size = rel(2)),
    legend.spacing.x = unit(20, "mm"),
    plot.title   = element_text(face = "bold", hjust = 0.5, size = rel(2))
  )

p_grid

ggsave("shap_grid.png", p_grid, width = 30, height = 12, dpi = 300)
```
